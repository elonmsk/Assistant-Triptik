
# Documentation - API LLM sur Render

## Vue d'ensemble

L'Assistant Triptik utilise une API LLM externe hÃ©bergÃ©e sur **Render** pour traiter les demandes des utilisateurs et gÃ©nÃ©rer des rÃ©ponses contextualisÃ©es. Cette documentation dÃ©taille l'architecture, les appels API, le traitement des rÃ©ponses et l'affichage des messages.

---

## ğŸŒ Configuration de l'API Externe

### Endpoint Principal
```typescript
const EXTERNAL_API_URL = process.env.EXTERNAL_API_URL || 
  "https://assistant-nouveaux-arrivants-france.onrender.com";
```

### URLs d'API Disponibles
- **API Standard** : `${EXTERNAL_API_URL}/api/chat`
- **API Streaming** : `${EXTERNAL_API_URL}/api/chat` (avec streaming response)

---

## ğŸ—ï¸ Architecture de l'API

### Fichiers Principaux

1. **`app/api/chat/route.ts`** - API standard avec rÃ©ponse complÃ¨te
2. **`app/api/chat/stream/route.ts`** - API avec streaming en temps rÃ©el

### Flux de DonnÃ©es
```mermaid
Frontend â†’ Next.js API Route â†’ Render API â†’ LLM â†’ Response Processing â†’ Frontend Display
```

---

## ğŸ“¡ API Standard (`/api/chat/route.ts`)

### ğŸ”„ Processus de RequÃªte

#### 1. Validation des DonnÃ©es d'EntrÃ©e
```typescript
interface RequestBody {
  messages: Array<{
    content: string;
    // autres propriÃ©tÃ©s du message
  }>;
}

// Validation
if (!messages || !Array.isArray(messages) || messages.length === 0) {
  return NextResponse.json({ 
    error: "Le tableau de messages est requis" 
  }, { status: 400 });
}
```

#### 2. Extraction du Message Utilisateur
```typescript
// RÃ©cupÃ©ration du dernier message de l'utilisateur
lastUserMessage = messages[messages.length - 1]?.content;

if (!lastUserMessage || typeof lastUserMessage !== 'string') {
  return NextResponse.json({ 
    error: "Message invalide" 
  }, { status: 400 });
}
```

#### 3. DÃ©tection du Contexte
```typescript
// Analyse du message pour dÃ©terminer le contexte appropriÃ©
const context = detectContext(lastUserMessage);
```

**Contextes SupportÃ©s :**
- Personne ayant obtenu le statut de rÃ©fugiÃ©
- Ã‰tudiant international en France
- Travailleur Ã©tranger en France
- Personne venue pour raisons familiales
- Nouvel arrivant en France
- Personne rÃ©sidant en France (par dÃ©faut)

#### 4. Appel vers l'API Render
```typescript
const controller = new AbortController();
const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s timeout

const response = await fetch(`${EXTERNAL_API_URL}/api/chat`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    message: lastUserMessage.trim(),
    context: context || undefined
  }),
  signal: controller.signal
});
```

### ğŸ›¡ï¸ Gestion des Erreurs et Fallback

#### 1. DÃ©tection de RÃ©ponses IncomplÃ¨tes
```typescript
function isResponseIncomplete(response: string): boolean {
  const indicators = [
    response.length < 50,                    // RÃ©ponse trop courte
    response.endsWith('...'),                // Points de suspension
    response.includes('reponse incomplete'), // Message explicite
    /\b(dans|de|les|des|en)\s*$/.test(response.trim()), // Fin par prÃ©position
    /[,;]\s*$/.test(response.trim()),       // Fin par ponctuation
    response.split('\n').length > 5 && !response.includes('ğŸ“š'), // Long texte sans sources
    response.includes('prÃ©sente dans de ') && response.endsWith('de ') // Pattern spÃ©cifique
  ];
  
  return indicators.some(condition => condition);
}
```

#### 2. SystÃ¨me de Fallback
```typescript
// En cas d'erreur API ou timeout
if (error.name === 'AbortError') {
  const fallbackResponse = formatResponse(
    generateFallbackResponse(lastUserMessage, context) + 
    "\n\nâš ï¸ *Timeout de l'API - rÃ©ponse de base fournie.*"
  );
  return NextResponse.json({ reply: fallbackResponse });
}
```

### ğŸ“ Formatage des RÃ©ponses

#### Fonction `formatResponse()`
```typescript
function formatResponse(response: string): string {
  let formatted = response;

  // 1. Formater les sections avec Ã©mojis comme titres markdown
  formatted = formatted.replace(/([ğŸ¥ğŸ–¥ï¸ğŸ“±ğŸ’»])\s*([^:\n]+)\s*:\s*([^\n]*)/g, '\n\n# $1 $2\n\n$3\n\n');
  formatted = formatted.replace(/([ğŸ“‹ğŸ“âš ï¸ğŸ†˜ğŸ’¡ğŸ“šâ±ï¸])\s*([^:\n]+)\s*:/g, '\n\n## $1 $2\n\n');
  
  // 2. Formater les Ã©tapes numÃ©rotÃ©es
  formatted = formatted.replace(/(\d+)\.\s*\*\*([^*]+)\*\*\s*:/g, '\n\n### $1. $2\n\n');
  
  // 3. Formater les listes Ã  puces
  formatted = formatted.replace(/^[\s]*-\s*([^:\n]+):\s*([^\n]*)/gm, '- **$1**: $2');
  
  // 4. Formater les liens
  formatted = formatted.replace(/\[([^\]]+)\]\s*\(\s*([^)]+)\s*\)/g, '[$1]($2)');
  
  // 5. Formater les alertes
  formatted = formatted.replace(/âš ï¸\s*([^:\n]+):/g, '\n\n> âš ï¸ **Attention**: $1\n\n');
  
  // 6. Nettoyer les sauts de ligne
  formatted = formatted.replace(/\n{4,}/g, '\n\n\n');
  
  return formatted.trim();
}
```

---

## ğŸš€ API Streaming (`/api/chat/stream/route.ts`)

### ğŸ”„ Processus de Streaming

#### 1. CrÃ©ation du Stream
```typescript
const encoder = new TextEncoder();
const stream = new ReadableStream({
  async start(controller) {
    // Envoi du signal de dÃ©but
    controller.enqueue(encoder.encode(`data: ${JSON.stringify({ type: 'start' })}\n\n`));
    
    // Traitement et streaming de la rÃ©ponse
    // ...
  }
});
```

#### 2. Simulation du Streaming Mot par Mot
```typescript
// DÃ©coupage de la rÃ©ponse en mots
const words = formattedResponse.split(' ');
let currentContent = '';

for (let i = 0; i < words.length; i++) {
  currentContent += (i > 0 ? ' ' : '') + words[i];
  
  // Envoi du chunk
  controller.enqueue(encoder.encode(`data: ${JSON.stringify({
    type: 'content',
    content: currentContent,
    done: false
  })}\n\n`));
  
  // DÃ©lai de 30ms entre les mots
  await new Promise(resolve => setTimeout(resolve, 30));
}
```

#### 3. Headers de Streaming
```typescript
return new NextResponse(stream, {
  headers: {
    'Content-Type': 'text/event-stream',
    'Cache-Control': 'no-cache',
    'Connection': 'keep-alive',
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'POST',
    'Access-Control-Allow-Headers': 'Content-Type',
  },
});
```

---

## ğŸ¯ DÃ©tection de Contexte

### Fonction `detectContext()`

```typescript
function detectContext(message: string): string | undefined {
  const lowerMessage = message.toLowerCase();
  
  const contexts = [
    {
      keywords: ['rÃ©fugiÃ©', 'demandeur asile', 'protection subsidiaire', 'apatride'],
      context: 'Personne ayant obtenu le statut de rÃ©fugiÃ© ou protection internationale'
    },
    {
      keywords: ['Ã©tudiant', 'universitÃ©', 'campus france', 'visa Ã©tudiant'],
      context: 'Ã‰tudiant international en France'
    },
    {
      keywords: ['travailleur', 'salariÃ©', 'carte de sÃ©jour salariÃ©', 'contrat de travail'],
      context: 'Travailleur Ã©tranger en France'
    },
    {
      keywords: ['conjoint franÃ§ais', 'mariage', 'regroupement familial', 'visa famille'],
      context: 'Personne venue en France pour raisons familiales'
    },
    {
      keywords: ['premiÃ¨re fois', 'nouvel arrivant', 'viens d\'arriver', 'rÃ©cemment arrivÃ©'],
      context: 'Nouvel arrivant en France'
    }
  ];

  for (const { keywords, context } of contexts) {
    if (keywords.some(keyword => lowerMessage.includes(keyword))) {
      return context;
    }
  }

  return 'Personne rÃ©sidant en France';
}
```

---

## ğŸ†˜ SystÃ¨me de Fallback

### RÃ©ponses de Secours PrÃ©dÃ©finies

#### 1. Demande d'Asile + PUMa
```typescript
if (lowerMessage.includes('demande d\'asile') && 
    (lowerMessage.includes('puma') || lowerMessage.includes('protection universelle'))) {
  return `ğŸ¥ **PUMa et demande d'asile en cours**

ğŸ“‹ **DÃ©lai de carence obligatoire :**
- Depuis janvier 2020, il y a un **dÃ©lai de carence de 3 mois** pour les demandeurs d'asile majeurs
- Vous devez attendre 3 mois aprÃ¨s l'enregistrement de votre demande d'asile

âš ï¸ **Exception importante :**
- Les **mineurs** demandeurs d'asile ont accÃ¨s immÃ©diat Ã  la PUMa
- Pas de dÃ©lai d'attente pour les enfants

ğŸ†˜ **Pendant les 3 premiers mois :**
- **Soins urgents** pris en charge aux urgences hospitaliÃ¨res
- **PASS** (Permanences d'AccÃ¨s aux Soins de SantÃ©) dans les hÃ´pitaux
- Centres de santÃ© communautaires
- Consultations gratuites dans certaines associations

ğŸ“ **Contacts utiles :**
- CPAM : 36 46
- 115 (urgence sociale)
- MÃ©decins du Monde, MÃ©decins Sans FrontiÃ¨res

â° **AprÃ¨s 3 mois :** Vous pourrez bÃ©nÃ©ficier de la PUMa complÃ¨te.`;
}
```

#### 2. RÃ©fugiÃ© + Assurance Maladie
```typescript
if (lowerMessage.includes('rÃ©fugiÃ©') && lowerMessage.includes('assurance maladie')) {
  return `ğŸ¥ **Assurance maladie et statut de rÃ©fugiÃ©**

FÃ©licitations pour l'obtention de votre statut de rÃ©fugiÃ© ! Concernant l'assurance maladie :

ğŸ“‹ **Votre situation actuelle :**
- Si vous bÃ©nÃ©ficiez actuellement de l'AME (Aide MÃ©dicale d'Ã‰tat), vous devez effectuer une nouvelle demande
- Votre couverture ne se poursuit PAS automatiquement

ğŸ”„ **DÃ©marches Ã  effectuer :**
1. **Demande d'affiliation Ã  l'Assurance Maladie** auprÃ¨s de votre CPAM
2. **Documents Ã  fournir :**
   - RÃ©cÃ©pissÃ© ou carte de sÃ©jour "rÃ©fugiÃ©"
   - Justificatif de domicile
   - PiÃ¨ce d'identitÃ©

â° **DÃ©lais :**
- Faites la demande **dÃ¨s que possible** pour Ã©viter toute interruption
- La CPAM a 2 mois pour traiter votre dossier

ğŸ¯ **Avantages du nouveau statut :**
- AccÃ¨s aux mÃªmes droits qu'un assurÃ© franÃ§ais
- PossibilitÃ© d'obtenir une carte Vitale
- Prise en charge Ã  100% selon votre situation

ğŸ“ **Contact :** 36 46 (service gratuit + prix d'un appel)

âš ï¸ **Important :** N'attendez pas la fin de vos droits AME pour faire la demande !`;
}
```

#### 3. RÃ©ponse GÃ©nÃ©rale par DÃ©faut
```typescript
return `ğŸ‘‹ Bonjour ! Je suis l'assistant pour les nouveaux arrivants en France.

Je peux vous aider sur :
ğŸ¥ SantÃ© (sÃ©curitÃ© sociale, mÃ©decins)
ğŸ  Logement (recherche, aides)
ğŸ“‹ Administratif (cartes, permis)
ğŸ’¼ Emploi et formation
ğŸš— Transport
ğŸ’° Finances

${context ? `\nğŸ¯ **Votre profil :** ${context}` : ''}

N'hÃ©sitez pas Ã  me poser une question plus prÃ©cise !`;
```

---

## ğŸ”§ IntÃ©gration Frontend (Ã‰tat Actuel)

### Ã‰tat de DÃ©veloppement
```typescript
// Dans les composants React (Ã©tat actuel)
const handleSendMessage = (message: string) => {
  console.log("Message envoyÃ©:", message);
  // TODO: Appel vers /api/chat ou /api/chat/stream
};
```

### IntÃ©gration Future PrÃ©vue
```typescript
// ImplÃ©mentation prÃ©vue
const handleSendMessage = async (message: string) => {
  setIsLoading(true);
  
  try {
    const response = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        messages: [{ content: message }]
      })
    });
    
    const data = await response.json();
    setMessages(prev => [...prev, 
      { content: message, role: 'user' },
      { content: data.reply, role: 'assistant' }
    ]);
  } catch (error) {
    console.error('Erreur API:', error);
  } finally {
    setIsLoading(false);
  }
};
```

---

## âš¡ Performance et Optimisations

### Timeouts et Limitations
- **Timeout API** : 30 secondes maximum
- **Fallback automatique** : En cas de timeout ou erreur
- **Retry logic** : Non implÃ©mentÃ© (fallback direct)

### Gestion des Erreurs
```typescript
// Types d'erreurs gÃ©rÃ©es
- AbortError (timeout)
- API externe indisponible (status !== 200)
- RÃ©ponse malformÃ©e
- Erreurs de configuration ('unhandled errors in a TaskGroup')
- RÃ©ponses incomplÃ¨tes
```

### Optimisations Render
- **API hÃ©bergÃ©e** : https://assistant-nouveaux-arrivants-france.onrender.com
- **Variable d'environnement** : `EXTERNAL_API_URL`
- **Fallback local** : RÃ©ponses prÃ©dÃ©finies si API indisponible

---

## ğŸ“Š Format de RÃ©ponse

### Structure Standard
```json
{
  "success": true,
  "response": "RÃ©ponse formatÃ©e en markdown avec Ã©mojis et sections"
}
```

### Structure d'Erreur
```json
{
  "success": false,
  "error": "Description de l'erreur"
}
```

### Format de Streaming
```
data: {"type": "start"}

data: {"type": "content", "content": "DÃ©but de rÃ©ponse...", "done": false}

data: {"type": "content", "content": "RÃ©ponse complÃ¨te", "done": true}
```

---

## ğŸš€ Ã‰volutions Futures

### AmÃ©liorations PrÃ©vues
1. **IntÃ©gration frontend complÃ¨te** des appels API
2. **Gestion d'Ã©tat des conversations** avec historique
3. **Cache des rÃ©ponses** pour optimiser les performances
4. **Streaming rÃ©el** depuis l'API Render
5. **MÃ©tadonnÃ©es de contexte** enrichies avec profil utilisateur
6. **Retry logic** avec backoff exponentiel

### Monitoring et Logging
- Logs des erreurs API externe
- MÃ©triques de performance
- Taux d'utilisation du fallback
- Analyse des contextes dÃ©tectÃ©s

---

## ğŸ” SÃ©curitÃ©

### Validations ImplÃ©mentÃ©es
- Validation des types de donnÃ©es d'entrÃ©e
- Sanitization des messages utilisateur
- Timeout pour Ã©viter les requÃªtes infinies
- Headers CORS appropriÃ©s pour le streaming

### ConsidÃ©rations de SÃ©curitÃ©
- Pas de stockage de donnÃ©es sensibles dans les logs
- API key non exposÃ©e cÃ´tÃ© client
- Validation cÃ´tÃ© serveur uniquement 